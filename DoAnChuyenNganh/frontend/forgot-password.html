<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quên mật khẩu - Laptop World</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div id="header-container"></div>

    <section class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="card shadow-lg">
                        <div class="card-body p-5">
                            <div class="text-center mb-4">
                                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                                    style="width: 80px; height: 80px; font-size: 2rem;">
                                    <i class="fas fa-key"></i>
                                </div>
                                <h2 class="text-gradient">Quên mật khẩu</h2>
                                <p class="text-muted">Nhập email để đặt lại mật khẩu</p>
                            </div>

                            <!-- Step 1: Request Reset -->
                            <div id="requestStep">
                                <form id="requestResetForm" onsubmit="requestPasswordReset(event)">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email đã đăng ký</label>
                                        <input type="email" class="form-control" id="email" required
                                            placeholder="example@email.com">
                                    </div>

                                    <div class="d-grid mb-3">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-paper-plane"></i> Gửi mã xác nhận
                                        </button>
                                    </div>

                                    <div class="text-center">
                                        <a href="login.html" class="text-muted">
                                            <i class="fas fa-arrow-left"></i> Quay lại đăng nhập
                                        </a>
                                    </div>
                                </form>
                            </div>

                            <!-- Step 2: Verify Code & Reset Password -->
                            <div id="resetStep" style="display: none;">
                                <div class="alert alert-info mb-4" id="codeDisplayAlert">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>Mã xác nhận:</strong> <span id="displayResetCode" class="fw-bold"></span>
                                    <br>
                                    <small class="text-muted">Không thể gửi email. Vui lòng sử dụng mã này.</small>
                                </div>

                                <div class="alert alert-success mb-4" id="emailSentAlert" style="display: none;">
                                    <i class="fas fa-envelope"></i> 
                                    <strong>Email đã được gửi!</strong>
                                    <br>
                                    <small>Vui lòng kiểm tra hộp thư đến (hoặc spam) để lấy mã xác nhận.</small>
                                </div>

                                <form id="resetPasswordForm" onsubmit="resetPassword(event)">
                                    <input type="hidden" id="resetEmail">

                                    <div class="mb-3">
                                        <label for="resetCode" class="form-label">Mã xác nhận</label>
                                        <input type="text" class="form-control" id="resetCode" required
                                            placeholder="Nhập mã 6 số" maxlength="6">
                                    </div>

                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">Mật khẩu mới</label>
                                        <input type="password" class="form-control" id="newPassword" required
                                            placeholder="Ít nhất 6 ký tự" minlength="6">
                                    </div>

                                    <div class="mb-3">
                                        <label for="confirmPassword" class="form-label">Xác nhận mật khẩu</label>
                                        <input type="password" class="form-control" id="confirmPassword" required
                                            placeholder="Nhập lại mật khẩu mới" minlength="6">
                                    </div>

                                    <div class="d-grid mb-3">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-check"></i> Đặt lại mật khẩu
                                        </button>
                                    </div>

                                    <div class="text-center">
                                        <button type="button" class="btn btn-link text-muted" onclick="backToRequest()">
                                            <i class="fas fa-arrow-left"></i> Quay lại
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="footer-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/components/header.js"></script>
    <script src="js/components/footer.js"></script>
    <script src="js/chatbot.js"></script>

    <script>
        // Request password reset
        async function requestPasswordReset(event) {
            event.preventDefault();

            const email = document.getElementById('email').value.trim();
            const submitButton = event.target.querySelector('button[type="submit"]');

            if (!validateEmail(email)) {
                showNotification('Email không hợp lệ', 'error');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

            try {
                const result = await api.post('/auth/forgot-password', { email });

                if (result.success) {
                    // Check if email was sent successfully
                    if (result.data.resetCode) {
                        // Email failed, show code directly (development fallback)
                        showNotification('Mã xác nhận đã được tạo!', 'success');
                        document.getElementById('displayResetCode').textContent = result.data.resetCode;
                        document.getElementById('codeDisplayAlert').style.display = 'block';
                    } else {
                        // Email sent successfully
                        showNotification('Mã xác nhận đã được gửi đến email của bạn!', 'success');
                        document.getElementById('codeDisplayAlert').style.display = 'none';
                    }
                    
                    document.getElementById('resetEmail').value = email;
                    
                    // Switch to reset step
                    document.getElementById('requestStep').style.display = 'none';
                    document.getElementById('resetStep').style.display = 'block';
                } else {
                    showNotification(result.message || 'Không tìm thấy email này', 'error');
                }
            } catch (error) {
                console.error('Request reset error:', error);
                showNotification('Lỗi kết nối đến server', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Gửi mã xác nhận';
            }
        }

        // Reset password
        async function resetPassword(event) {
            event.preventDefault();

            const email = document.getElementById('resetEmail').value;
            const resetCode = document.getElementById('resetCode').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitButton = event.target.querySelector('button[type="submit"]');

            // Validation
            if (resetCode.length !== 6) {
                showNotification('Mã xác nhận phải có 6 số', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showNotification('Mật khẩu phải có ít nhất 6 ký tự', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('Mật khẩu xác nhận không khớp', 'error');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

            try {
                const result = await api.post('/auth/reset-password', {
                    email,
                    resetCode,
                    newPassword
                });

                if (result.success) {
                    showNotification('Đặt lại mật khẩu thành công!', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                } else {
                    showNotification(result.message || 'Mã xác nhận không đúng hoặc đã hết hạn', 'error');
                }
            } catch (error) {
                console.error('Reset password error:', error);
                showNotification('Lỗi kết nối đến server', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-check"></i> Đặt lại mật khẩu';
            }
        }

        // Back to request step
        function backToRequest() {
            document.getElementById('resetStep').style.display = 'none';
            document.getElementById('requestStep').style.display = 'block';
            document.getElementById('requestResetForm').reset();
        }
    </script>

  <!-- Scroll to Top Button -->
  <script src="js/components/scroll-to-top.js"></script>
</body>

</html>
