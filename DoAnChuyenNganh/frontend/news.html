<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diễn đàn - Laptop World</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            background: #f0f2f5;
        }
        .post-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .post-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
        }
        .post-author-info h6 {
            margin: 0;
            font-weight: 600;
            font-size: 15px;
        }
        .post-time {
            color: #65676b;
            font-size: 13px;
        }
        .post-content {
            padding: 0 20px 16px;
        }
        .post-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #050505;
        }
        .post-text {
            color: #050505;
            font-size: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .post-image {
            width: 100%;
            max-height: 600px;
            object-fit: cover;
            cursor: pointer;
        }
        .post-stats {
            padding: 12px 20px;
            border-top: 1px solid #e4e6eb;
            border-bottom: 1px solid #e4e6eb;
            display: flex;
            justify-content: space-between;
            color: #65676b;
            font-size: 14px;
        }
        .post-actions {
            padding: 8px 20px;
            display: flex;
            gap: 8px;
        }
        .post-action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            color: #65676b;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .post-action-btn:hover {
            background: #f2f3f5;
        }
        .post-action-btn i {
            margin-right: 6px;
        }
        .comments-section {
            padding: 16px 20px;
            background: #f7f8fa;
        }
        .comment-input-wrapper {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e4e6eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #65676b;
            font-size: 14px;
            font-weight: 600;
        }
        .comment-input {
            flex: 1;
            background: #f0f2f5;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
        }
        .comment-input:focus {
            outline: none;
            background: #e4e6eb;
        }
        .comment-item {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .comment-content {
            flex: 1;
            background: #f0f2f5;
            border-radius: 18px;
            padding: 8px 12px;
        }
        .comment-author {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }
        .comment-text {
            font-size: 14px;
            color: #050505;
            word-wrap: break-word;
        }
        .comment-time {
            font-size: 12px;
            color: #65676b;
            margin-top: 4px;
            padding-left: 40px;
        }
        .comment-actions {
            font-size: 12px;
            color: #65676b;
            margin-top: 4px;
            padding-left: 40px;
        }
        .comment-actions button {
            background: none;
            border: none;
            color: #65676b;
            font-weight: 600;
            cursor: pointer;
            padding: 0 8px;
        }
        .comment-actions button:hover {
            text-decoration: underline;
        }
        .load-more {
            text-align: center;
            padding: 20px;
        }
        .show-more-btn {
            color: #385898;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        .show-more-btn:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>

    <div class="bg-gradient text-danger py-4">
        <div class="container">
            <h1><i class="fas fa-comments"></i> Diễn đàn</h1>
            <p class="mb-0">Chia sẻ và thảo luận về công nghệ</p>
        </div>
    </div>

    <section class="py-4">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div id="newsContainer">
                        <div class="text-center py-5">
                            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                            <p class="mt-3">Đang tải bài viết...</p>
                        </div>
                    </div>

                    <div id="loadMoreContainer" class="load-more" style="display: none;">
                        <button class="btn btn-outline-primary" onclick="loadMore()">
                            <i class="fas fa-chevron-down"></i> Xem thêm bài viết
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="footer-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/components/header.js"></script>
    <script src="js/components/footer.js"></script>
    <script src="js/chatbot.js"></script>
    <script src="js/components/scroll-to-top.js"></script>

    <script>
        let currentPage = 1;
        let currentUser = null;
        let allNews = [];
        let hasMore = true;

        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Vui lòng đăng nhập để xem diễn đàn', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return;
            }

            // Get current user
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            currentUser = user;

            loadNews();
        });

        async function loadNews(page = 1) {
            try {
                const response = await api.get(`/news?page=${page}&limit=5`);

                if (response.success) {
                    if (page === 1) {
                        allNews = response.data;
                        displayNews(allNews);
                    } else {
                        allNews = [...allNews, ...response.data];
                        displayNews(allNews);
                    }

                    hasMore = response.data.length === 5;
                    document.getElementById('loadMoreContainer').style.display = hasMore ? 'block' : 'none';
                } else {
                    showNotification('Không thể tải bài viết', 'error');
                }
            } catch (error) {
                console.error('Load news error:', error);
                document.getElementById('newsContainer').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle fa-3x text-danger"></i>
                        <p class="mt-3">Lỗi kết nối đến server</p>
                    </div>
                `;
            }
        }

        function loadMore() {
            currentPage++;
            loadNews(currentPage);
        }

        function displayNews(newsList) {
            const container = document.getElementById('newsContainer');

            if (newsList.length === 0) {
                container.innerHTML = `
                    <div class="post-card text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted"></i>
                        <p class="mt-3">Chưa có bài viết nào</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = newsList.map(news => `
                <div class="post-card" id="post-${news.IdTinTuc}">
                    <!-- Post Header -->
                    <div class="post-header">
                        <div class="post-avatar">
                            ${news.TacGia.charAt(0).toUpperCase()}
                        </div>
                        <div class="post-author-info flex-grow-1">
                            <h6>${escapeHtml(news.TacGia)}</h6>
                            <div class="post-time">
                                <i class="fas fa-clock"></i> ${formatTimeAgo(news.NgayTao)}
                            </div>
                        </div>
                    </div>

                    <!-- Post Content -->
                    <div class="post-content">
                        <div class="post-title">${news.DanhMuc || 'Tin tức'}</div>
                        <div class="post-text">${escapeHtml(news.NoiDung)}</div>
                    </div>

                    <!-- Post Image -->
                    ${news.AnhBia ? `
                        <img src="${getImageUrl(news.AnhBia)}" class="post-image" alt="${escapeHtml(news.TieuDe)}" onclick="viewImage('${getImageUrl(news.AnhBia)}')">
                    ` : ''}

                    <!-- Post Stats -->
                    <div class="post-stats">
                        <span><i class="fas fa-eye"></i> ${news.LuotXem} lượt xem</span>
                        <span><i class="fas fa-comment"></i> <span id="comment-count-${news.IdTinTuc}">${news.SoBinhLuan || 0}</span> bình luận</span>
                    </div>

                    <!-- Post Actions -->
                    <div class="post-actions">
                        <button class="post-action-btn" onclick="toggleComments(${news.IdTinTuc})">
                            <i class="fas fa-comment"></i> Bình luận
                        </button>
                        <button class="post-action-btn" onclick="sharePost(${news.IdTinTuc})">
                            <i class="fas fa-share"></i> Chia sẻ
                        </button>
                    </div>

                    <!-- Comments Section -->
                    <div class="comments-section" id="comments-${news.IdTinTuc}" style="display: none;">
                        <!-- Comment Input -->
                        <div class="comment-input-wrapper">
                            <div class="comment-avatar">
                                ${currentUser.HoTen ? currentUser.HoTen.charAt(0).toUpperCase() : 'U'}
                            </div>
                            <input type="text" class="comment-input" placeholder="Viết bình luận..." 
                                id="comment-input-${news.IdTinTuc}" 
                                onkeypress="if(event.key==='Enter') addComment(${news.IdTinTuc})">
                            <button class="btn btn-primary btn-sm" onclick="addComment(${news.IdTinTuc})">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <!-- Comments List -->
                        <div id="comments-list-${news.IdTinTuc}">
                            <div class="text-center text-muted py-2">
                                <i class="fas fa-spinner fa-spin"></i> Đang tải bình luận...
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function toggleComments(newsId) {
            const commentsSection = document.getElementById(`comments-${newsId}`);
            
            if (commentsSection.style.display === 'none') {
                commentsSection.style.display = 'block';
                await loadComments(newsId);
            } else {
                commentsSection.style.display = 'none';
            }
        }

        async function loadComments(newsId) {
            try {
                const response = await api.get(`/news/${newsId}/comments`);
                
                if (response.success) {
                    displayComments(newsId, response.data);
                    document.getElementById(`comment-count-${newsId}`).textContent = response.data.length;
                }
            } catch (error) {
                console.error('Load comments error:', error);
            }
        }

        function displayComments(newsId, comments) {
            const container = document.getElementById(`comments-list-${newsId}`);
            
            if (comments.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-2">Chưa có bình luận nào</div>';
                return;
            }

            // Tổ chức comments thành cây (parent-child)
            const commentMap = {};
            const rootComments = [];
            
            comments.forEach(comment => {
                commentMap[comment.IdBinhLuan] = { ...comment, replies: [] };
            });
            
            comments.forEach(comment => {
                if (comment.ParentId && commentMap[comment.ParentId]) {
                    commentMap[comment.ParentId].replies.push(commentMap[comment.IdBinhLuan]);
                } else if (!comment.ParentId) {
                    rootComments.push(commentMap[comment.IdBinhLuan]);
                }
            });

            container.innerHTML = rootComments.map(comment => renderComment(comment, newsId)).join('');
        }

        function renderComment(comment, newsId, isReply = false) {
            const marginClass = isReply ? 'ms-5' : '';
            const canModify = comment.UserId === currentUser.IdUser || comment.UserId === currentUser.idUser;
            
            let html = `
                <div class="comment-item ${marginClass}" id="comment-${comment.IdBinhLuan}">
                    <div class="comment-avatar">
                        ${comment.HoTen.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-grow-1">
                        <div class="comment-content">
                            <div class="comment-author">${escapeHtml(comment.HoTen)}</div>
                            <div class="comment-text">${escapeHtml(comment.NoiDung)}</div>
                        </div>
                        <div class="comment-time">
                            ${formatTimeAgo(comment.NgayTao)}
                            <span class="comment-actions">
                                <button onclick="showReplyForm(${comment.IdBinhLuan}, ${newsId})">Trả lời</button>
                                ${canModify ? `
                                    <button onclick="editComment(${comment.IdBinhLuan}, '${escapeHtml(comment.NoiDung).replace(/'/g, "\\'")}')">Sửa</button>
                                    <button onclick="deleteComment(${comment.IdBinhLuan}, ${newsId})">Xóa</button>
                                ` : ''}
                            </span>
                        </div>
                        
                        <!-- Reply form (ẩn mặc định) -->
                        <div id="reply-form-${comment.IdBinhLuan}" style="display: none;" class="mt-2">
                            <div class="comment-input-wrapper">
                                <div class="comment-avatar">
                                    ${currentUser.HoTen ? currentUser.HoTen.charAt(0).toUpperCase() : 'U'}
                                </div>
                                <input type="text" class="comment-input" placeholder="Viết trả lời..." 
                                    id="reply-input-${comment.IdBinhLuan}" 
                                    onkeypress="if(event.key==='Enter') addComment(${newsId}, ${comment.IdBinhLuan})">
                                <button class="btn btn-primary btn-sm" onclick="addComment(${newsId}, ${comment.IdBinhLuan})">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render replies
            if (comment.replies && comment.replies.length > 0) {
                html += comment.replies.map(reply => renderComment(reply, newsId, true)).join('');
            }
            
            return html;
        }

        function showReplyForm(commentId, newsId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            if (replyForm) {
                replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
                if (replyForm.style.display === 'block') {
                    document.getElementById(`reply-input-${commentId}`).focus();
                }
            }
        }

        async function addComment(newsId, parentId = null) {
            const inputId = parentId ? `reply-input-${parentId}` : `comment-input-${newsId}`;
            const input = document.getElementById(inputId);
            const noiDung = input.value.trim();
            
            if (!noiDung) return;

            try {
                const response = await api.post(`/news/${newsId}/comments`, { 
                    noiDung,
                    parentId 
                });
                
                if (response.success) {
                    input.value = '';
                    await loadComments(newsId);
                    showNotification('Đã thêm bình luận', 'success');
                    
                    // Ẩn form reply nếu có
                    if (parentId) {
                        const replyForm = document.getElementById(`reply-form-${parentId}`);
                        if (replyForm) replyForm.style.display = 'none';
                    }
                } else {
                    showNotification(response.message || 'Không thể thêm bình luận', 'error');
                }
            } catch (error) {
                console.error('Add comment error:', error);
                showNotification('Lỗi kết nối', 'error');
            }
        }

        async function editComment(commentId, currentText) {
            const newText = prompt('Sửa bình luận:', currentText);
            if (!newText || newText === currentText) return;

            try {
                const response = await api.put(`/news/comments/${commentId}`, { noiDung: newText });
                
                if (response.success) {
                    showNotification('Đã cập nhật bình luận', 'success');
                    location.reload();
                } else {
                    showNotification(response.message || 'Không thể cập nhật', 'error');
                }
            } catch (error) {
                console.error('Edit comment error:', error);
                showNotification('Lỗi kết nối', 'error');
            }
        }

        async function deleteComment(commentId, newsId) {
            if (!confirm('Bạn có chắc muốn xóa bình luận này?')) return;

            try {
                const response = await api.delete(`/news/comments/${commentId}`);
                
                if (response.success) {
                    showNotification('Đã xóa bình luận', 'success');
                    await loadComments(newsId);
                } else {
                    showNotification(response.message || 'Không thể xóa', 'error');
                }
            } catch (error) {
                console.error('Delete comment error:', error);
                showNotification('Lỗi kết nối', 'error');
            }
        }

        function sharePost(newsId) {
            const url = `${window.location.origin}/news-detail.html?id=${newsId}`;
            navigator.clipboard.writeText(url);
            showNotification('Đã copy link bài viết', 'success');
        }

        function viewImage(src) {
            window.open(src, '_blank');
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Vừa xong';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' phút trước';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' giờ trước';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' ngày trước';
            
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
    </script>
</body>
</html>
