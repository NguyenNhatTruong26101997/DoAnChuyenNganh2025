<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán - Laptop World</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div id="header-container"></div>

    <div class="bg-gradient text-white py-4">
        <div class="container">
            <h1><i class="fas fa-credit-card"></i> Thanh Toán</h1>
        </div>
    </div>

    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <form id="checkoutForm" onsubmit="handleCheckout(event)">
                        <!-- Customer Info (Read-only) -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4"><i class="fas fa-user"></i> Thông tin khách hàng</h5>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Thông tin này lấy từ tài khoản của bạn và không thể chỉnh sửa
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Họ và tên</label>
                                        <input type="text" class="form-control" id="customerName" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Số điện thoại</label>
                                        <input type="tel" class="form-control" id="customerPhone" readonly>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="customerEmail" readonly>
                                </div>

                                <div class="mb-0">
                                    <label class="form-label">Địa chỉ</label>
                                    <textarea class="form-control" id="customerAddress" readonly rows="2"></textarea>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i> 
                                        <span id="addressNote">Chưa có địa chỉ. Vui lòng cập nhật trong <a href="profile.html" target="_blank">Hồ sơ</a></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Info (Editable) -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="fas fa-shipping-fast"></i> Thông tin giao hàng</h5>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="sameAsCustomer" onchange="toggleShippingInfo()">
                                    <label class="form-check-label" for="sameAsCustomer">
                                        Giao hàng đến địa chỉ khác
                                    </label>
                                </div>

                                <div id="shippingInfoSection" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Họ tên người nhận *</label>
                                            <input type="text" class="form-control" id="receiverName" placeholder="Nhập họ tên người nhận">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Số điện thoại người nhận *</label>
                                            <input type="tel" class="form-control" id="receiverPhone" placeholder="Nhập số điện thoại">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Email người nhận</label>
                                        <input type="email" class="form-control" id="receiverEmail" placeholder="Nhập email (tùy chọn)">
                                    </div>
                                </div>

                                <div class="mb-0">
                                    <label class="form-label">Địa chỉ giao hàng đầy đủ *</label>
                                    <textarea class="form-control" id="address" required rows="3" 
                                        placeholder="Nhập địa chỉ đầy đủ: Số nhà, tên đường, phường/xã, quận/huyện, tỉnh/thành phố"></textarea>
                                    <div class="form-text">Ví dụ: 123 Nguyễn Văn Linh, Phường Tân Phú, Quận 7, TP. Hồ Chí Minh</div>
                                </div>

                                <div class="mb-0 mt-3">
                                    <label class="form-label">Ghi chú</label>
                                    <textarea class="form-control" id="note" rows="2"
                                        placeholder="Ghi chú về đơn hàng, thời gian giao hàng mong muốn... (tùy chọn)"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4"><i class="fas fa-money-bill-wave"></i> Phương thức thanh toán</h5>

                                <!-- COD -->
                                <div class="form-check mb-3 p-3 border rounded" style="cursor: pointer;" onclick="document.getElementById('cod').click()">
                                    <input class="form-check-input" type="radio" name="payment" id="cod" value="cod" checked onchange="updatePaymentMethod()">
                                    <label class="form-check-label w-100" for="cod" style="cursor: pointer;">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-money-bill-wave fa-2x text-success me-3"></i>
                                            <div>
                                                <strong>Thanh toán khi nhận hàng (COD)</strong>
                                                <div class="text-muted small">Thanh toán bằng tiền mặt khi nhận hàng</div>
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <!-- Bank Transfer -->
                                <div class="form-check mb-3 p-3 border rounded" style="cursor: pointer;" onclick="document.getElementById('bank').click()">
                                    <input class="form-check-input" type="radio" name="payment" id="bank" value="bank" onchange="updatePaymentMethod()">
                                    <label class="form-check-label w-100" for="bank" style="cursor: pointer;">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-university fa-2x text-primary me-3"></i>
                                            <div>
                                                <strong>Chuyển khoản ngân hàng</strong>
                                                <div class="text-muted small">Chuyển khoản trực tiếp đến tài khoản ngân hàng</div>
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <!-- Bank Transfer Details -->
                                <div id="bankDetails" class="alert alert-info" style="display: none;">
                                    <h6><i class="fas fa-info-circle"></i> Thông tin chuyển khoản:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Ngân hàng:</strong> Vietcombank</p>
                                            <p class="mb-1"><strong>Số tài khoản:</strong> 0394127625</p>
                                            <p class="mb-1"><strong>Chủ tài khoản:</strong> NGUYEN NHAT TRUONG</p>
                                            <p class="mb-0"><strong>Nội dung:</strong> <span id="transferContent">Thanh toan LaptopWorld</span></p>
                                        </div>
                                        <div class="col-md-6 text-center">
                                            <img id="qrCode" src="" alt="QR Code" class="img-fluid" style="max-width: 200px; display: none;">
                                            <p class="text-muted small mt-2">Quét mã QR để chuyển khoản nhanh</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-check-circle"></i> Đặt hàng
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Order Summary -->
                <div class="col-lg-4">
                    <div class="card sticky-top" style="top: 100px;">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Đơn hàng của bạn</h5>

                            <div id="orderItems" class="mb-3">
                                <!-- Order items -->
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between mb-2">
                                <span>Tạm tính:</span>
                                <span id="subtotal">0đ</span>
                            </div>

                            <div class="d-flex justify-content-between mb-2">
                                <span>Phí vận chuyển:</span>
                                <span>Miễn phí</span>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between mb-3">
                                <strong>Tổng cộng:</strong>
                                <strong class="text-primary" style="font-size: 1.25rem;" id="total">0đ</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="footer-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/components/header.js"></script>
    <script src="js/components/footer.js"></script>
    <script src="js/cart-api.js"></script>
    <script src="js/chatbot.js"></script>

    <script>
        let cartData = null;
        let userData = null;

        document.addEventListener('DOMContentLoaded', async function () {
            // Check if user is logged in
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Vui lòng đăng nhập để thanh toán', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return;
            }

            // Load user data from API to get latest info including address
            try {
                const userResponse = await api.get('/users/profile');
                if (userResponse.success) {
                    userData = userResponse.data;
                    // Update localStorage with latest data
                    localStorage.setItem('user', JSON.stringify(userData));
                } else {
                    // Fallback to localStorage
                    userData = JSON.parse(localStorage.getItem('user'));
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Fallback to localStorage
                userData = JSON.parse(localStorage.getItem('user'));
            }

            // Load cart
            cartData = await getCartAPI();
            
            if (!cartData || !cartData.items || cartData.items.length === 0) {
                showNotification('Giỏ hàng trống', 'error');
                setTimeout(() => {
                    window.location.href = 'cart.html';
                }, 1500);
                return;
            }

            loadOrderSummary();
            prefillUserInfo();
        });

        function prefillUserInfo() {
            if (userData) {
                // Fill customer info
                document.getElementById('customerName').value = userData.HoTen || '';
                document.getElementById('customerPhone').value = userData.SoDienThoai || '';
                document.getElementById('customerEmail').value = userData.Email || '';
                
                // Fill customer address
                const customerAddress = document.getElementById('customerAddress');
                const addressNote = document.getElementById('addressNote');
                
                if (userData.DiaChi) {
                    customerAddress.value = userData.DiaChi;
                    addressNote.innerHTML = '<i class="fas fa-check-circle text-success"></i> Địa chỉ từ hồ sơ của bạn';
                    
                    // Auto-fill shipping address if empty
                    const shippingAddress = document.getElementById('address');
                    if (!shippingAddress.value) {
                        shippingAddress.value = userData.DiaChi;
                    }
                } else {
                    customerAddress.value = '';
                    addressNote.innerHTML = '<i class="fas fa-info-circle"></i> Chưa có địa chỉ. Vui lòng cập nhật trong <a href="profile.html" target="_blank">Hồ sơ</a>';
                }
            }
        }

        function toggleShippingInfo() {
            const checkbox = document.getElementById('sameAsCustomer');
            const section = document.getElementById('shippingInfoSection');
            const receiverName = document.getElementById('receiverName');
            const receiverPhone = document.getElementById('receiverPhone');
            
            if (checkbox.checked) {
                section.style.display = 'block';
                receiverName.required = true;
                receiverPhone.required = true;
            } else {
                section.style.display = 'none';
                receiverName.required = false;
                receiverPhone.required = false;
                receiverName.value = '';
                receiverPhone.value = '';
                document.getElementById('receiverEmail').value = '';
            }
        }

        function loadOrderSummary() {
            const orderItems = document.getElementById('orderItems');

            orderItems.innerHTML = '';
            cartData.items.forEach(item => {
                orderItems.innerHTML += `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${item.TenSanPham} x${item.SoLuongChiTietGioHang}</span>
                        <span>${formatCurrency(item.GiaSanPham * item.SoLuongChiTietGioHang)}</span>
                    </div>
                `;
            });

            document.getElementById('subtotal').textContent = formatCurrency(cartData.total);
            document.getElementById('total').textContent = formatCurrency(cartData.total);
        }

        function updatePaymentMethod() {
            const selectedPayment = document.querySelector('input[name="payment"]:checked').value;
            const bankDetails = document.getElementById('bankDetails');
            
            // Hide bank details by default
            bankDetails.style.display = 'none';
            
            if (selectedPayment === 'bank') {
                // Show bank transfer details with QR code
                bankDetails.style.display = 'block';
                generateQRCode();
            }
        }

        function generateQRCode() {
            // Generate QR code using VietQR API
            const bankId = '970436'; // Vietcombank
            const accountNo = '0394127625';
            const accountName = 'NGUYEN NHAT TRUONG';
            const amount = cartData ? cartData.total : 0;
            const description = 'Thanh toan don hang';
            
            // VietQR API URL
            const qrUrl = `https://img.vietqr.io/image/${bankId}-${accountNo}-compact2.png?amount=${amount}&addInfo=${encodeURIComponent(description)}&accountName=${encodeURIComponent(accountName)}`;
            
            const qrCode = document.getElementById('qrCode');
            qrCode.src = qrUrl;
            qrCode.style.display = 'block';
        }

        async function handleCheckout(event) {
            event.preventDefault();

            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

            try {
                // Get form data
                const address = document.getElementById('address').value.trim();
                const note = document.getElementById('note').value.trim();
                const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

                // Validate address
                if (!address || address.length < 20) {
                    showNotification('Vui lòng nhập địa chỉ đầy đủ (tối thiểu 20 ký tự)', 'error');
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-check-circle"></i> Đặt hàng';
                    return;
                }

                // Check if shipping to different address
                const sameAsCustomer = document.getElementById('sameAsCustomer').checked;
                let receiverName, receiverPhone, receiverEmail;

                if (sameAsCustomer) {
                    // Use different shipping info
                    receiverName = document.getElementById('receiverName').value.trim();
                    receiverPhone = document.getElementById('receiverPhone').value.trim();
                    receiverEmail = document.getElementById('receiverEmail').value.trim();

                    if (!receiverName || !receiverPhone) {
                        showNotification('Vui lòng nhập đầy đủ thông tin người nhận', 'error');
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-check-circle"></i> Đặt hàng';
                        return;
                    }
                } else {
                    // Use customer info
                    receiverName = document.getElementById('customerName').value.trim();
                    receiverPhone = document.getElementById('customerPhone').value.trim();
                    receiverEmail = document.getElementById('customerEmail').value.trim();
                }

                // Create order
                const result = await api.post('/orders', {
                    hoTenNguoiNhan: receiverName,
                    soDienThoaiNguoiNhan: receiverPhone,
                    emailNguoiNhan: receiverEmail,
                    diaChiGiao: address,
                    ghiChu: note,
                    phuongThucThanhToan: paymentMethod === 'cod' ? 'Tien mat' : 'Chuyen khoan'
                });

                if (result.success) {
                    showNotification('Đặt hàng thành công!', 'success');

                    // Update cart count
                    if (typeof window.updateCartCount === 'function') {
                        await window.updateCartCount();
                    }

                    // Show different messages based on payment method
                    let message = `Cảm ơn bạn đã đặt hàng!\n\nMã đơn hàng: ${result.data.maDonHang}\n\n`;
                    
                    if (paymentMethod === 'cod') {
                        message += 'Bạn sẽ thanh toán khi nhận hàng.\n\nChúng tôi sẽ liên hệ với bạn trong thời gian sớm nhất để xác nhận đơn hàng.';
                    } else if (paymentMethod === 'bank') {
                        message += 'Vui lòng chuyển khoản theo thông tin đã cung cấp.\n\nĐơn hàng sẽ được xử lý sau khi chúng tôi nhận được thanh toán.';
                    }

                    setTimeout(() => {
                        alert(message);
                        window.location.href = 'orders.html';
                    }, 1000);
                } else {
                    showNotification(result.message || 'Đặt hàng thất bại', 'error');
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-check-circle"></i> Đặt hàng';
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showNotification('Lỗi kết nối đến server', 'error');
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-check-circle"></i> Đặt hàng';
            }
        }
    </script>

  <!-- Scroll to Top Button -->
  <script src="js/components/scroll-to-top.js"></script>
</body>

</html>